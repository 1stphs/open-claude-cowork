# 智能排程系统：“极简主义” (Lean & Mean) 架构设计

## 1. 设计哲学
> **TL;DR (太长不看版)**：别为了修个水管造天网 (Skynet)。杀鸡焉用牛刀，用对工具才是王道。

-   **确定性内核 > 概率性 Agent**：排程本质上是一个数学约束问题（Constraint Satisfaction Problem - CSP）。它追求的是**最优解**，而不是**创意解**。处理逻辑请用求解器 (Solver)，别用 LLM。
-   **LLM 仅作接口，不作大脑**：LLM 只能用于翻译（人话 -> JSON，JSON -> 人话解释）。永远不要相信 LLM 能准确地数到 10。
-   **事件驱动状态**：使用稳健的状态机 (State Machine / finite automata) 和消息队列，而不是脆弱的“Agent 动态交接”。状态变更必须是事务性的，而不是对话式的。

---

## 2. 系统架构

本系统采用标准的微服务架构，外挂一个“AI 网关”。

```mermaid
graph TD
    User[用户 (移动端/PC)] --> Gateway[API 网关]
    Gateway --> NLU[NLU 服务 (LLM Wrapper)]
    Gateway --> Scheduler[排程核心 (求解器)]
    Gateway --> BizData[商业逻辑服务]
    
    NLU -->|解析自然语言| Gateway
    Scheduler -->|查询约束条件| DB[(PostgreSQL)]
    Scheduler -->|运行优化算法| Solver[OR-Tools / OptaPlanner]
    BizData -->|计算损益 P&L| DB
```

### 3. 核心组件

#### 3.1 NLU 服务（系统的“耳朵”）
-   **职责**：心无旁骛地将用户意图解析为严格类型的 JSON Schema。
-   **技术栈**：微调过的小模型 (如 Llama-3-8B) 或 GPT-4o-mini，配合 `response_format={type: "json_object"}`。
-   **输入**： “我想在3月下旬给40只猴子排个房。”
-   **输出**：
    ```json
    {
      "intent": "create_booking",
      "entities": {
        "species": "cynomolgus_monkey",
        "count": 40,
        "start_window": { "after": "2026-03-20", "before": "2026-03-31" }
      },
      "missing_fields": ["experiment_type"]
    }
    ```
-   **约束**：**零**业务逻辑。只负责提取，不负责思考。

#### 3.2 排程引擎（系统的“大脑”）
-   **职责**：寻找满足所有硬性约束的时间-空间插槽 (Time-Space Slots)。
-   **技术栈**：Google OR-Tools (CP-SAT) 或 Python/Go/Rust 自研启发式算法。
-   **逻辑**：
    -   **硬约束 (必须满足)**：
        -   房间容量 >= 动物数量 * 1.05
        -   种属兼容性（猫鼠不同室）
        -   生物安全等级 (BSL-2 对应特定病毒)
    -   **软约束 (尽量满足)**：
        -   最小化项目间隙（提升利用率）
        -   最大化连续块（提升效率）
        -   最少化搬迁（提升稳定性）
-   **输出**：一组排好序的有效 `TimeSlot` 对象。

#### 3.3 商业逻辑服务（系统的“钱包”）
-   **职责**：计算每个有效插槽的 P&L (损益) 影响。
-   **逻辑**：
    -   **机会成本**：如果一个低利润项目占用了黄金档期，扣分。
    -   **持有成本**：计算空置房间的每日成本。
-   **输出**：每个选项的财务评分。

#### 3.4 通知服务（系统的“嘴巴”）
-   **职责**：基于状态机流转发送确定性的通知。
-   **渠道**：飞书/Lark, Email。
-   **触发器**：
    -   `booking_created` -> 检查库存 -> (如有必要) 提醒采购。
    -   `timeout_warning` -> 发送“确认或释放”链接。

---

## 4. 关键工作流

### W1: 智能接入与求解 (Intelligent Intake & Solving)
1.  **用户**：“4月中旬能不能安排一个30条狗的 P2 毒理实验？”
2.  **NLU**：提取 `{ "species": "dog", "count": 30, "date": "2026-04-15", "type": "tox_p2" }`。
3.  **排程器**：查询数据库。
    -   *约束检查*：狗房容量。
    -   *过滤*：排除维修/检疫期房间。
    -   *结果*：找到 2 个选项。
        -   选项 A: 房间 D-101 (4月12日开始, 需空置等待3天)。
        -   选项 B: 房间 D-105 (4月20日开始, 完美衔接)。
4.  **商业逻辑**：
    -   选项 A 得分: 95 (利用率更高)。
    -   选项 B 得分: 80 (留有空隙)。
5.  **网关**：返回标准 JSON 响应。
6.  **UI**：渲染对比卡片供用户选择。

### W2: 自动化优化（系统的“磁盘碎片整理”）
*通过 Cron Job 每晚运行。*
1.  **扫描器**：识别所有“软预订 (Soft Reservations)”（低置信度订单）。
2.  **求解器**：模拟“如果我们移动这些订单会怎样？”
3.  **逻辑**：如果把项目 X 从房间 A 移到房间 B，能在房间 A 腾出一个巨大的连续空闲块 -> **生成建议**。
4.  **结果**：给管理员发送通知：“优化建议：建议移动项目 X，可节省 14 个房间日。”

## 5. 为什么这比 "Agent Swarm" 强？
1.  **可预测性**：输入 A 永远得到输出 B。出了问题能调试 (Debug)。
2.  **性能**：数据库索引和数学求解器比 LLM 问答快几个数量级。
3.  **成本**：核心逻辑层**零 Token** 成本。
4.  **可靠性**：数学求解器里没有“幻觉”。它要么找到解，要么证明无解。
