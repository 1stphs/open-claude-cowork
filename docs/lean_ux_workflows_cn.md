# 智能排程系统：双端协同与核心场景 (Lean 版)

> **设计哲学**：
> - **移动端 (Mobile)**：极简输入，实时反馈，异常预警。核心是“快”。
> - **PC 端 (Manager)**：上帝视角，决策博弈，深度分析。核心是“全”。

---

## 1. 移动端 (Mobile) - Sales/BD 的“猎手终端”

**定位**：随时随地管理机会，而不是坐在办公室填表。所有的“排程计算”都在后端瞬间完成，前端只展示结果。

### 场景 A：需求变更与即时重算 (The "Live Update")
*   **用户动作**：Sales 在拜访客户时，客户说：“项目可能要推迟两周，且动物数量从 30 只增加到 40 只。” Sales 在手机上修改订单字段。
*   **后台逻辑 (Lean Core)**：
    1.  API 接收 Update 请求 -> `is_dirty = true`。
    2.  立即触发 **Solver (求解器)** 针对新约束 (`Start+2w`, `Count=40`) 进行试算。
    3.  **原子化检查**：
        -   *库存检查*：40 只够吗？不够 -> 触发《缺口预警》。
        -   *房间检查*：原定房间还能放下吗？放不下 -> 寻找新房间。
*   **前端反馈**：
    -   若成功：Toast 提示“已更新排期，新启动日：4月20日”。
    -   若失败：弹窗警告“库存不足，需推迟至5月1日采购到位，由 Procurement 处理中”。

### 场景 B：订单取消与资源释放 (The "Release")
*   **用户动作**：客户取消项目，Sales 点击“关闭订单”。
*   **后台逻辑**：
    1.  状态机流转：`Soft_Book` -> `Cancelled`。
    2.  **触发器 (Trigger)**：`on_booking_cancelled`。
    3.  **资源回收**：立即释放该订单占用的 `TimeSlot`。
    4.  **机会回填**：扫描等待队列 (Waitlist) 中是否有因资源不足被卡住的 **P1** 项目，若有，自动填补空缺并通知 P1 的负责人。
*   **前端反馈**：
    -   显示“订单已取消，资源已释放”。如有违约金逻辑，自动计算并展示。

### 场景 C：供试品状态与反馈闭环 (The "Feedback Loop")
*   **用户动作**：Sales 收到供试品 (Test Article) 已发货的消息，在 App 点击“更新供试品状态 -> 已发货”。
*   **后台逻辑**：
    1.  更新项目置信度：`Confidence_Score` 提升。
    2.  **排程精细化**：锁定 T0 (启动日) 的确定性。求解器将该项目的 `Start_Window` 从“4月中旬”收敛为“4月12日”。
*   **异常处理**：
    -   **超时降级**：后台 Cron Job 每天扫描。若项目距离启动 < 2 周且供试品状态仍为“未发货”。
    -   **动作**：自动发送 Push 通知给 Sales：“请在 24 小时内更新供试品状态，否则系统将释放 50% 的预留资源给等待队列。”

### 场景 D：即时查询与报价 (Instant Inquiry & Quotation)
> **痛点解决**：从“等 2 天”缩短为“2 秒钟”。
*   **用户动作**：Sales 在客户现场，直接语音/文字输入：“3月20号左右，40只食蟹猴，做个毒理，大概多少钱？能排上吗？”
*   **后台逻辑 (Real-time Solver)**：
    1.  **NLU 解析**：提取 `{date: "2026-03-20", count: 40, species: "monkey", type: "tox"}`。
    2.  **约束求解**：Solver 立即查询 3 月中下旬的动物库存与房间空档。
    3.  **计算报价 (P&L)**：结合当前动物采购价 + 房间空置成本 + 实验标准报价，生成预估预算。
*   **前端反馈 (3 种选项)**：
    -   **选项 1 (完美匹配)**：“3月22日启动，有房有猴。预估预算：¥XXX 万。”
    -   **选项 2 (更早/捡漏)**：“3月15日有个 P4 项目取消了，现在插队可打 95 折，预估预算：¥XX.X 万。”
    -   **选项 3 (成本最优)**：“推迟到 4月1日，拼笼做，预估预算：¥XX.X 万 (省 10%)。”
*   **后续动作**：Sales 点击“生成报价单”，系统自动生成 PDF 发送给客户邮箱，并锁定 **Soft_Book** (24小时有效期)。

---

## 2. PC 端 (Manager) - PM/SD 的“指挥塔”

**定位**：处理复杂冲突，进行多方案博弈，监控全局资源健康度。

### 功能模块 A：方案对比工作台 (Scenario Workbench)
*   **界面布局**：左右分栏，展示求解器生成的 2-3 套方案。
*   **展示逻辑**：
    -   **方案 A (时效优先)**：启动最早，但使用了大房间养少量动物（利用率低，成本高）。
    -   **方案 B (成本优先)**：等待 1 周，拼笼放入小房间（利用率高，成本低）。
    -   **高亮冲突点**：
        -   界面用**红色**标记冲突：“选择方案 A 将**强行挤占**项目 X (P4) 的软预订。”
*   **决策动作**：Manager 点击“确认方案 A” -> 触发“冲突调解器”。

### 功能模块 B：资源全景甘特图 (The "God View")
*   **数据源**：直接读取数据库的 `TimeSlot` 表，而非通过 DataAgent 询问。
*   **可视化**：
    -   纵轴：房间号 (Room ID) / 动物批次。
    -   横轴：时间轴 (周/天)。
    -   **色块含义**：
        -   深蓝：硬锁 (Hard Lock, P1/P2)。
        -   浅蓝：软预订 (Soft Book, P3-P5)。
        -   灰色：维修/消毒/检疫。
        -   红色波浪线：资源冲突/超售区域。
*   **交互**：点击任意色块，右侧滑出抽屉，显示：
    -   绑定项目 ID (Project ID)。
    -   客户名称 / Sales 负责人。
    -   当前状态 (及最后更新时间)。
    -   **上下文日志**：显示 NLU 解析的历史记录（例如：“Sales 昨天下午修改了启动时间”）。

### 功能模块 C：冲突调解器 (Conflict Resolver)
*   **触发场景**：Manager 批准了一个 P1 急单，系统计算必须抢占一个 P4 项目的房间。
*   **交互流程**：
    1.  **弹窗提示**：“确认批准 P1 项目？这将导致 P4 项目 (客户: ABC Pharma) 被推迟。”
    2.  **自动处置**：
        -   点击“确认”后。
        -   系统将 P4 项目状态改为 `Pending_Reschedule` (待重排)。
        -   **自动化通知**：系统向 P4 的 Sales 发送通知（邮件/飞书）：“由于高优先级项目介入，您的项目 P4 需调整排期，系统已为您自动推荐备选方案：[链接]，请与客户确认。”
    3.  **人工介入**：如果 Sales 拒绝调整，可以在系统内发起“资源仲裁申请”，由更高层级介入。

---

## 3. 为什么这个设计更 "Lean"？

1.  **去除了“聊天式”办公**：Sales 不需要跟 Leader Agent 聊天来改时间，直接改字段。系统自动计算结果。
2.  **确定性的反馈**：没有“Agent 正在思考”，只有“求解器返回可行解”或“无解”。
3.  **透明的上下文**：甘特图直接透视数据库，所见即所得，不需要 DataAgent 每次去“快照”一次。一切都是实时数据。
