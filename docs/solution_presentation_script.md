# 智能排程系统：解决方案汇报 (Intelligent Scheduling System - Lean Architecture)

> **目标**：全面展示产品设计理念、技术架构与核心业务场景。
---

## Part 1: 设计哲学与架构全景 (Philosophy & Architecture)

### Slide 1: 封面 (Title Slide)
*   **标题**：从“人工接单”到“算力接单” —— 下一代智能排程系统
*   **副标题**：用确定性的数学引擎 (Solver)，重构不确定的业务流
*   **演讲者**：[许可/🐝蜂略]

### Slide 2: 核心理念 - Lean & Mean
*   **拒绝黑盒**：我们不制造一个只会聊天的 Chatbot，而是构建一个精准的数学引擎。
*   **人机分工**：
    *   **LLM (大语言模型)**：只做“翻译官”。负责听懂人话，转成结构化数据。
    *   **Solver (求解器)**：只做“计算器”。负责在毫秒级内遍历百万种组合，找到最优解。
    *   **Human (人)**：只做“决策者”。在系统提供的 2-3 个最优方案中拍板。

---

## Part 2: 技术架构 (System Architecture)

### Slide 3: 架构全景图
*(展示微服务架构图)*
*   **Gateway (网关)**：流量入口。
*   **NLU Service (耳朵)**：基于 Fine-tuned Llama-3/GPT-4o-mini，负责意图提取，0 业务逻辑。
*   **Solver Engine (大脑)**：基于 Google OR-Tools / OptaPlanner，毫秒级约束求解。
*   **Business Logic (钱包)**：实时 P&L 计算，评估每个 TimeSlot 的财务价值。
*   **Notification (嘴巴)**：基于状态机流转，发送确定性通知。

*   **NLU 服务 (耳朵)**：
    *   不管销售怎么说（语音/文字），精准提取关键要素：`时间`、`数量`、`种属`、`实验类型`。
    *   *技术*：Fine-tuned Llama-3 / GPT-4o-mini，零业务逻辑，纯提取。
*   **排程引擎 (大脑)**：
    *   核心是一个 **CSP (约束满足问题)** 求解器。
    *   *硬约束*：房间容量、生物安全等级、种属兼容性。
    *   *软约束*：利用率最大化、搬迁最小化。
    *   *技术*：Google OR-Tools / OptaPlanner。
*   **商业逻辑 (钱包)**：
    *   实时计算 P&L (损益)。每一条排期建议背后，都有一笔即时的成本帐。


## Part 2: 核心引擎详解 (Core Engine)

### Slide 4: NLU 服务 - 精准意图识别
*   **输入**：“3月20号左右，40只食蟹猴，做个毒理。”
*   **输出 (JSON Schema)**：
    ```json
    {
      "intent": "create_booking",
      "entities": {
        "species": "cynomolgus_monkey",
        "count": 40,
        "start_window": { "after": "2026-03-20", "before": "2026-03-31" }
      }
    }
    ```
*   **技术亮点**：`Structured Output` 强制约束，杜绝自由发挥。

### Slide 5: 排程求解器 - 约束模型 (The Solver)
*   **硬约束 (Hard Constraints) - 必须满足**：
    *   房间容量 >= 动物数量 * 1.05 (含损耗余量)。
    *   生物安全等级 (BSL-2) 匹配。
    *   种属兼容性 (No Rat next to Monkey)。
*   **软约束 (Soft Constraints) - 优化目标**：
    *   最小化项目间隙 (Gap Minimization)。
    *   最大化连续空块 (Contiguous Block Maximization)。
    *   最少化搬迁成本。

### Slide 6: P&L 财务评分模型 (The Wallet)
*   **不仅仅是排得下，更要排得赚。**
*   **评分公式**：`Score = (毛利 * H1) - (机会成本 * H2) - (空置成本 * H3)`
*   **决策逻辑**：
    *   如果一个低毛利项目占用了仅仅 3 天的黄金档期（阻碍了后续可能的长单），Solver 会自动给予低分推荐，建议其平移。

---

## Part 3: 核心算法流程 (Key Algorithms)

### Slide 7: W1 - 智能接入与即时求解 (Intelligent Intake)
1.  **用户请求** -> **NLU 解析** -> **Solver 查询 (200ms)**。
2.  **并行计算**：Solver 同时计算 "最早启动"、"成本最低"、"利用率最高" 三条路径。
3.  **结果排序**：根据 P&L 得分排序，直接返回前端。
4.  **优势**：将原本需要 2 天的人工计算缩短至秒级。

### Slide 8: W2 - 夜间自动优化 (Auto-Defrag)
*   **类比**：磁盘碎片整理。
*   **触发**：每晚 Cron Job 扫描全库。
*   **逻辑**：
    1.  识别所有 "Soft Reservation" (低置信度订单)。
    2.  模拟 "如果将项目 A 从 Room 101 移到 Room 105，能否腾出连续 30 天的大空档？"
    3.  若收益 > 阈值，生成优化建议，次日早上推送给管理员。

---

## Part 4: 场景演示 - 移动端 (Mobile Sales)

### Slide 9: 场景 A - 即时查询与报价 (Instant Inquiry)
> **痛点**：客户问由价，销售回公司查表，客户流失。
*   **操作**：Sales 现场语音输入需求。
*   **系统反馈 (3 选项)**：
    1.  **完美匹配**：4/15 启动，¥200万 (标准价)。
    2.  **捡漏模式**：4/10 启动 (插队 P4 空档)，¥190万 (95折)。
    3.  **成本最优**：4/20 启动，¥180万 (拼笼方案)。
*   **闭环**：点击 "生成报价单" -> 锁定资源 (24h 有效)。

### Slide 10: 场景 B - 动态变更 (Live Update)
*   **操作**：客户变更需求 (时间/数量)。
*   **逻辑**：API 接收 update -> `is_dirty=True` -> Solver 立即重算。
*   **反馈**：
    *   *成功*：Toast 提示 "已更新排期"。
    *   *失败*：弹窗提示 "库存不足，需采购介入"，直接触发采购工单。

### Slide 11: 场景 C - 反馈闭环与超时机制 (Feedback Loop)
*   **操作**：Sales 更新 "供试品已发货"。
*   **逻辑**：项目置信度提升，Solver 锁定 T0。
*   **预警机制**：
    *   若临近启动 T-7 天仍未发货，系统自动倒计时。
    *   T-3 天触发强提醒："请在一日内更新，否则释放 50% 预留资源"。

---

## Part 5: 场景演示 - PC 端 (Manager Dashboard)

### Slide 12: 功能 A - 方案对比工作台 (Scenario Workbench)
*   **界面**：左中右三栏，平行展示 Solver 生成的 2-3 套方案。
*   **高亮差异**：
    *   方案 A：时效优先，但需拆分房间。
    *   方案 B：成本优先，利用现有空隙，但需等待 1 周。
*   **决策**：管理员一键 "Confirm"，系统自动执行状态流转。

### Slide 13: 功能 B - 资源全景甘特图 (The God View)
*   **数据源**：直接连接 DB `TimeSlot` 表，无中间层，无幻觉。
*   **可视化**：
    *   **深蓝**：硬锁 (Hard Lock)。
    *   **浅蓝**：软预订 (Soft Book)。
    *   **红色波浪**：冲突/超售预警区。
*   **透视**：点击色块，查看 NLU 解析的历史上下文 (谁改的？改了什么？)。

### Slide 14: 功能 C - 冲突调解器 (Conflict Resolver)
*   **场景**：批准 P1 急单，系统检测到必然抢占 P4 项目。
*   **自动化安抚流程**：
    1.  弹窗提示冲突影响面 (Revenue impact)。
    2.  管理员确认抢占。
    3.  系统**自动**为 P4 项目计算备选方案 (如顺延 1 周)。
    4.  系统**自动**发送通知给 P4 销售："因紧急调整，为您推荐新排期..."。

