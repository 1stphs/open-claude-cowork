# 智能排程资源调度 SOP (标准作业程序)

**版本号**：V1.0
**适用对象**：运营部、项目管理部（PM）、蜂略智能调度 Agent
**核心目标**：在满足合规（GLP）的前提下，最大化资源利用率，通过精细化的优先级和超售管理，解决产销冲突。

---

### 一、 核心逻辑定义 (Logic Definitions)

本章节定义 Agent 进行排程计算时的**三项基础判定因子**。

#### 1. 优先级与超售规则 (Priority & Overselling)

**原则**：资源冲突时，高优先级（P1）无条件抢占低优先级（P4）。同等级别下，先到先得。

| 优先级 | 供试品(TA)状态 | 时间窗 | 定义归属 | 动作/跟进频率 | **超售规则 (核心算法)** |
| --- | --- | --- | --- | --- | --- |
| **P1** | **已生产** | < 1个月 | **预定** (Confirmed) | 每周跟进直至送达 | **🈲 不可超售** (硬锁定) |
| **P2** | **生产中** | 1-3个月 | **预定** (Confirmed) | 每周跟进直至送达 | **🈲 不可超售** (硬锁定) |
| **P3** | **计划生产** | 3-6个月 | 视为 **预约** (Reserved) | 每2周跟进 | **⚠️ 可 1:1 超售** (允许撞单，需人工确认) |
| **P4** | **联系CDMO** | > 6个月 | 视为 **预约** (Reserved) | 每月跟进 | **⚠️ 可 1:1 超售** |
| **P5** | **仅意向/未中标** | 不定 | **纯预约** (Leads) | 销售自行跟进 | **🚀 可 1:3 超售** (按30%延期率计算) |

* **资源保留有效期（自动释放机制）**：
* Agent 每日扫描“未反馈”项目，若超过以下时限，自动释放资源给排队项目：
* 距离启动 < 1个月：保留 **1周**
* 距离启动 1-3个月：保留 **2周**
* 距离启动 > 3个月：保留 **3周**



#### 2. 房间状态流转 (Room Lifecycle)

排程必须计算房间的物理状态链条，不可仅看“当前空闲”。

* **时间轴计算公式**：


* **状态定义**：
* 🔴 **实验中 (Occupied)**：严禁插入。
* 🟡 **清洗/消毒 (Washout/Cleaning)**：物理空闲，但合规不可用。
* 🟢 **空置 (Available)**：可立即排程。
* 🔵 **未来锁定 (Future Locked)**：已被 P1/P2 项目锁定。



#### 3. 动物资源供给 (Animal Supply)

排程需综合考虑“库存”与“采购交期”。

* **计算逻辑**：
* **场景 A：库存充足**


* **场景 B：库存不足 (需外购)**


* **适应期规则**：外购动物必须预留 **X天** (如7-14天) 适应期后方可开始实验。



---

### 二、 排程执行流程 (Execution Workflow)

这是数字员工（Agent）执行排程任务的标准步骤。

#### 步骤 1：资格审查与定级 (Qualification)

1. **输入**：项目合同状态、供试品进度（TA Status）、预计启动时间。
2. **判定**：
* 有合同/中标 + 交接PM -> 进入 **P1-P4** 判定流程。
* 无合同/未中标 -> 直接归为 **P5**，执行 1:3 超售策略。



#### 步骤 2：资源匹配与时间窗计算 (Matching)

1. **房间匹配**：
* 筛选符合 GLP/种属/容量要求的房间。
* 检查房间在“预计启动时间”是否处于 [空置] 或 [清洗结束]。


2. **动物匹配**：
* **Check 1 (自有)**：查询库存中是否有足量、适龄、且清洗期（Washout）已结束的动物。
* **Check 2 (外购)**：若库存不足，调用 `Calculate_Procurement_Lead_Time` 工具，计算最早到货时间。
* **结果取大值**：




#### 步骤 3：冲突检测与抢占 (Conflict Resolution)

当资源不足时，触发抢占逻辑：

1. **扫描**：查询目标时间段内已占用的项目。
2. **对比**：
* 若新项目为 **P1/P2**，且占用者为 **P3/P4/P5** -> **建议抢占**。
* 若新项目优先级 <= 占用者 -> **排队等待**或**建议改期**。


3. **超售处理**：
* 对于 P3/P4/P5 类项目，允许在同一时间段、同一资源上记录多个“预约”，但在甘特图上标记为“⚠️ 风险冲突（待定）”。



#### 步骤 4：锁定与释放 (Lock & Release)

1. **锁定**：
* P1/P2 项目：写入数据库，状态为 `Hard Lock`（硬锁）。
* P3/P4/P5 项目：写入数据库，状态为 `Soft Book`（软预订，允许被抢）。


2. **自动跟进**：
* Agent 根据定义的频率（每周/两周/月）发送邮件/钉钉提醒 PM 更新供试品状态。
* **超时释放**：若 PM 在有效期（1-3周）内未更新状态，Agent 自动将状态改为 `Released` 并通知排队项目。



---

### 三、 给数字员工的指令 (Instruction for Agent)

如果您使用 Claude/GPT 搭建 Agent，请将以下内容直接填入 System Prompt 或 `skill.md`：

```markdown
## Skill: 智能排程计算器

### 核心原则
你必须严格遵守以下优先级顺序：P1 > P2 > P3 > P4 > P5。
当资源冲突时，始终优先满足供试品已就位（P1/P2）的项目。

### 规则细节
1. **超售检查**：
   - 如果项目属于 P1 或 P2（供试品3个月内生产），**禁止超售**，必须确保 100% 资源独占。
   - 如果项目属于 P3 或 P4（供试品 >3个月），允许 **1:1 超售**（即允许2个项目抢1个坑，提示冲突）。
   - 如果项目属于 P5（未中标），允许 **1:3 超售**。

2. **时间计算**：
   - 实验开始时间必须晚于：`Current_Date` + `Procurement_Time` (如需购买) + `Acclimatization_Time` (适应期)。
   - 必须检查房间的 `Cleaning_Period` (清洗期)，清洗期间不可排程。

3. **释放机制**：
   - 检查 `Last_Update_Date`。
   - 规则：
     - Start < 1 month: 7 days without update -> Release.
     - Start 1-3 months: 14 days without update -> Release.
     - Start > 3 months: 21 days without update -> Release.

```

### 四、 异常处理机制 (Exception Handling)

* **供试品延期**：若 P1 项目供试品未按时到达，Agent 需立即将其降级为 P2 或 P3，并释放硬锁定的资源给候补队列。
* **紧急插单 (VIP)**：若遇老板特批的 VIP 项目（无论供试品状态），人工通过 Agent 的“强制排程”接口录入，系统自动将原占用项目推迟，并生成“影响影响报告”发送给受影响的 PM。